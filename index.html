<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Dashboard - ❤️❤️❤️</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
    rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <style>
    td,
    th {
      text-align: center;
    }

    .reset-zoom-btn:hover {
      cursor: pointer;
    }
  </style>

  <!-- =======================================================
  * Template Name: NiceAdmin
  * Updated: Mar 09 2023 with Bootstrap v5.2.3
  * Template URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center">
        <img src="assets/img/logo.png" alt="">
        <span class="d-none d-lg-block">❤️❤️❤️</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><!-- End Logo -->

    <div class="search-bar">
      <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Cerca per id Discord" title="Enter search keyword">
        <button type="submit" title="Search"><i class="bi bi-search"></i></button>
      </form>
    </div><!-- End Search Bar -->
    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">

        <li class="nav-item d-block d-lg-none">
          <a class="nav-link nav-icon search-bar-toggle " href="#">
            <i class="bi bi-search"></i>
          </a>
        </li><!-- End Search Icon-->
      </ul>
    </nav><!-- End Icons Navigation -->

  </header><!-- End Header -->

  <!-- ======= Sidebar ======= -->
  <aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
      <li class="nav-item">
        <a class="nav-link " href="index.html">
          <i class="bi bi-grid"></i>
          <span>Dashboard</span>
        </a>
      </li><!-- End Dashboard Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" href="users-profile.html">
          <i class="bi bi-person"></i>
          <span>Profile</span>
        </a>
      </li><!-- End Profile Page Nav -->
    </ul>
  </aside><!-- End Sidebar-->

  <main id="main" class="main">

    <div class="pagetitle">
      <h1>Dashboard</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Home</a></li>
          <li class="breadcrumb-item active">Dashboard</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <section class="section dashboard">
      <div class="row">

        <!-- Left side columns -->
        <div class="col-lg-8">
          <div class="row">

            <!-- Sales Card -->
            <div class="col-xxl-4 col-md-6">
              <div class="card info-card sales-card">
                <div class="card-body">
                  <h5 class="card-title">Blocks <span>| Totali creati</span></h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="bi bi-box"></i>
                    </div>
                    <div class="ps-3">
                      <h6 class="max-blocks">
                        <div class="spinner-border text-secondary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </h6>
                    </div>
                  </div>
                </div>

              </div>
            </div><!-- End Sales Card -->

            <!-- Revenue Card -->
            <div class="col-xxl-4 col-md-6">
              <div class="card info-card revenue-card">
                <div class="card-body">
                  <h5 class="card-title">Money <span>| Max in circolazione</span></h5>

                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="bi bi-currency-dollar"></i>
                    </div>
                    <div class="ps-3">
                      <h6 class="max-money">
                        <div class="spinner-border text-secondary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </h6>
                    </div>
                  </div>
                </div>

              </div>
            </div><!-- End Revenue Card -->

            <!-- Customers Card -->
            <div class="col-xxl-4 col-xl-12">

              <div class="card info-card customers-card">
                <div class="card-body">
                  <h5 class="card-title">Utenti <span>| Totali</span></h5>

                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="bi bi-people"></i>
                    </div>
                    <div class="ps-3">
                      <h6 class="max-users">
                        <div class="spinner-border text-secondary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </h6>
                    </div>
                  </div>

                </div>
              </div>

            </div><!-- End Customers Card -->

            <!-- Reports -->
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Bilancio <span>| Totale Portagli di ogni persona</span></h5>
                  <!-- Line Chart -->
                  <div id="reportsChart"></div>
                  <!-- End Line Chart -->

                </div>

              </div>
            </div><!-- End Reports -->

            <!-- Top Selling -->
            <div class="col-12">
              <div class="card top-selling overflow-auto">

                <div class="card-body pb-0">
                  <h5 class="card-title">I più scambiati</h5>

                  <table class="table table-borderless">
                    <thead>
                      <tr>
                        <th scope="col"></th>
                        <th scope="col">Nome</th>
                        <th scope="col">Scambi</th>
                        <th scope="col">Allenatore</th>
                        <th scope="col">Allenatore Precendente</th>
                        <th scope="col">Prezzo Massimo</th>
                      </tr>
                    </thead>
                    <tbody class="Top-selling-p">
                    </tbody>
                  </table>

                </div>

              </div>
            </div><!-- End Top Selling -->

          </div>
        </div><!-- End Left side columns -->

        <!-- Right side columns -->
        <div class="col-lg-4">


          <!-- Website Traffic -->
          <div class="card">
            <div class="card-body pb-0">
              <h5 class="card-title">Bilancio Server | <a class="bilancio-server"></a></h5>

              <div id="trafficChart" style="min-height: 600px;" class="echart"></div>
            </div>
          </div><!-- End Website Traffic -->


          <!-- Recent Activity -->
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Attività recenti <span>| Today</span></h5>

              <div class="activity recent-blocks" style="word-break: break-all;">
              </div>

            </div>
          </div><!-- End Recent Activity -->




        </div><!-- End Right side columns -->

      </div>
    </section>

  </main><!-- End #main -->
  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Copyright <strong><span>❤️❤️❤️</span></strong>. All Rights Reserved
    </div>
    <div class="credits">
      <!-- All the links in the footer should remain intact. -->
      <!-- You can delete the links only if you purchased the pro version. -->
      <!-- Licensing information: https://bootstrapmade.com/license/ -->
      <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/ -->
      Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"
    integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/chart.js/chart.umd.js"></script>
  <script>
    const select = (el, all = false) => {
      el = el.trim()
      if (all) {
        return [...document.querySelectorAll(el)]
      } else {
        return document.querySelector(el)
      }
    }
    async function GenPieGraph(data) {
      data.sort((a, b) => b.value - a.value);
      var mychart = echarts.init(document.getElementById('trafficChart'));
      let option = {
        tooltip: {
          trigger: 'item'
        },
        legend: {
          top: '5%',
          left: 'center'
        },
        series: [{
          name: 'Balance',
          type: 'pie',
          radius: ['40%', '70%'],
          avoidLabelOverlap: false,
          label: {
            show: false,
            position: 'center'
          },
          emphasis: {
            label: {
              show: true,
              fontSize: '18',
              fontWeight: 'bold',
              formatter: function (params) {
                return params.value.toLocaleString("it-IT", { style: "currency", currency: "EUR", minimumFractionDigits: 0, maximumFractionDigits: 0 });
              }
            }
          },
          labelLine: {
            show: false
          },
          data: data,
          tooltip: {
            trigger: 'item',
            formatter: function (params) {
              return '<strong>' + params.name + '<strong></br><span style="color:blue">' + params.value.toLocaleString("it-IT", { style: "currency", currency: "EUR", minimumFractionDigits: 0, maximumFractionDigits: 0 }) + "</span>";
            }
          },
        }]
      }
      // Use setOption() method to render the chart
      mychart.setOption(option);
      // Add event listener for the 'finished' event
      mychart.on('finished', function () {
        window.addEventListener('resize', function () {
          // Resize the chart whenever the window is resized
          mychart.resize();
        });
      });




    }

    function GenGraph(dataset) {
      let apexhcahart = new ApexCharts(document.querySelector("#reportsChart"), {
        series: dataset,
        chart: {
          height: 450,
          type: 'area',
          toolbar: {
            show: true
          },
        },
        markers: {
          size: 4
        },
        fill: {
          type: "gradient",
          gradient: {
            shadeIntensity: 1,
            opacityFrom: 0.3,
            opacityTo: 0.4,
            stops: [0, 90, 100]
          }
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          curve: 'smooth',
          width: 2
        },
        zoomout: true,
        xaxis: {
          type: 'datetime',

        },
        yaxis: {
          labels: {
            formatter: function (val) {
              return val.toLocaleString("it-IT", { style: "currency", currency: "EUR", minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
          }
        }
      }).render();
    }

    function timeAgo(timestamp) {
      const seconds = Math.floor((new Date() - timestamp) / 1000);
      let interval = Math.floor(seconds / 31536000);

      if (interval >= 1) {
        return interval + " Anni";
      }
      interval = Math.floor(seconds / 2592000);
      if (interval >= 1) {
        return interval + " Mesi";
      }
      interval = Math.floor(seconds / 86400);
      if (interval >= 1) {
        return interval + " Giorni";
      }
      interval = Math.floor(seconds / 3600);
      if (interval >= 1) {
        return interval + " Ore";
      }
      interval = Math.floor(seconds / 60);
      if (interval >= 1) {
        return interval + " Minuti";
      }
      return Math.floor(seconds) + " Secondi";
    }

    function get_NickName(person, blockchain) {
      let new_name = null;
      for (let i = 0; i < blockchain.chain.length; i++) {
        const block = blockchain.chain[i];
        if (block.message.startsWith("Change Nickname") && block.transactions.fromAddress == person) {
          new_name = block.message.substring("Change Nickname".length).trim();
        }
      }
      return new_name;
    }

    //FETCH BLOCKCHAIN
    $.get('https://blockchainpokejson.000webhostapp.com/', async function (blockchain) {
      // Use the blockchain data here
      // Create an object to store the required information
      const blockchainInfo = {
        numBlocks: blockchain.chain.length,
        totalAmount: 0,
        addresses: {}
      };
      let listOfItems = [];
      // Loop through each block in the blockchain
      for (let i = 0; i < blockchain.chain.length; i++) {
        const block = blockchain.chain[i];

        const transaction = block.transactions;

        // Add the amount of the current transaction to the total amount
        if (transaction.amount && transaction.fromAddress == "00000") {
          blockchainInfo.totalAmount += transaction.amount;
        }
        // Update the addresses object with the current transaction
        const fromAddress = transaction.fromAddress;
        const toAddress = transaction.toAddress;
        const amount = transaction.amount || 0;
        const date = new Date(block.timestamp);
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;

        // Update the fromAddress object
        if (!blockchainInfo.addresses[fromAddress]) {
          blockchainInfo.addresses[fromAddress] = {
            totalAmount: 0,
            dailyWallet: {}
          };
        }
        blockchainInfo.addresses[fromAddress].totalAmount -= amount;
        if (!blockchainInfo.addresses[fromAddress].dailyWallet[dateString]) {
          blockchainInfo.addresses[fromAddress].dailyWallet[dateString] = 0;
        }
        blockchainInfo.addresses[fromAddress].dailyWallet[dateString] -= amount;

        // Update the toAddress object
        if (!blockchainInfo.addresses[toAddress]) {
          blockchainInfo.addresses[toAddress] = {
            totalAmount: 0,
            dailyWallet: {}
          };
        }
        blockchainInfo.addresses[toAddress].totalAmount += amount;
        if (!blockchainInfo.addresses[toAddress].dailyWallet[dateString]) {
          blockchainInfo.addresses[toAddress].dailyWallet[dateString] = 0;
        }
        blockchainInfo.addresses[toAddress].dailyWallet[dateString] += amount;

        //* top Selling
        let num, owner, last_owner;
        if (block.transactions.fromAddress != "Server" && block.transactions.fromAddress != "00000" && block.transactions.item) {
          if (listOfItems[block.transactions.item]) {
            num = listOfItems[block.transactions.item].value + 1;
            owner = block.transactions.toAddress;
            last_owner = block.transactions.fromAddress;
          } else {
            num = 1;
            owner = block.transactions.toAddress;
            last_owner = block.transactions.fromAddress;
          }
          listOfItems[block.transactions.item] = { value: num, owner: owner, last_owner: last_owner };
          if (!listOfItems[block.transactions.item].MaxPrice) {
            listOfItems[block.transactions.item].MaxPrice = 0;
          }
        }
      }
      //* top Selling SET MAX PRICE
      let MaxPrice;
      for (let i = 0; i < blockchain.chain.length; i++) {
        const block = blockchain.chain[i];
        if (block.message && block.message.includes("Buyed item")) {
          const str = block.message;
          if (str) {
            const match = str.match(/\((\w+)\)/);
            if (match) {
              const name = match[1]; // extract the captured group
              if (listOfItems[name].MaxPrice < block.transactions.amount) {
                MaxPrice = block.transactions.amount;
                listOfItems[name].MaxPrice = MaxPrice;
              }
            }
          }
        }
      }

      delete blockchainInfo.addresses["00000"]
      delete blockchainInfo.addresses["undefined"]
      delete blockchainInfo.addresses["Server"]
      // Normalize the data for each name sum of the days before
      // * Remove if you want the dailyWallet or losses
      let data = blockchainInfo.addresses
      for (const name in data) {
        const dailyWallet = data[name].dailyWallet;
        const dates = Object.keys(dailyWallet);
        if (dates.length > 1) {
          const sortedDates = dates.sort();
          let previousValue = dailyWallet[sortedDates[0]];
          for (let i = 1; i < sortedDates.length; i++) {
            const currentDate = sortedDates[i];
            const currentValue = dailyWallet[currentDate];
            if (currentDate !== getPreviousDate(currentDate)) {
              if (!currentValue) {
                dailyWallet[currentDate] = previousValue;
              } else {
                dailyWallet[currentDate] += previousValue;
              }
            }
            previousValue = dailyWallet[currentDate];
          }
        }
      }

      function getPreviousDate(dateString) {
        const date = new Date(dateString);
        date.setDate(date.getDate() - 1);
        return date.toISOString().slice(0, 10);
      }

      //fill the datas 
      let maxDay = null;

      for (const person in data) {
        const dailyWallet = data[person].dailyWallet;
        const days = Object.keys(dailyWallet);
        const lastDay = days[days.length - 1];
        if (!maxDay || lastDay > maxDay) {
          maxDay = lastDay;
        }
      }
      function getFirstDailyWalletKey(character) {
        const dailyWallet = data[character].dailyWallet;
        const keys = Object.keys(dailyWallet);
        return keys[0];
      }
      for (const aa in data) {
        const startDate = new Date(getFirstDailyWalletKey(aa));
        const endDate = new Date(maxDay);
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          const dateStr = d.toISOString().slice(0, 10);
          if (!data[aa].dailyWallet[dateStr]) {
            const prevDate = new Date(d);
            prevDate.setDate(prevDate.getDate() - 1);
            const prevDateStr = prevDate.toISOString().slice(0, 10);
            data[aa].dailyWallet[dateStr] = data[aa].dailyWallet[prevDateStr];
          }
        }
        if (data[aa].dailyWallet[getFirstDailyWalletKey(aa)] == undefined) {
          delete data[aa]
        }
      }

      //SORT ARRAY ASC 
      for (const person in data) {
        const dailyWallet = data[person].dailyWallet;
        const sortedWallet = {};
        Object.keys(dailyWallet).sort().forEach(function (day) {
          sortedWallet[day] = dailyWallet[day];
        });
        data[person].dailyWallet = sortedWallet;
      }

      //SORT NICKNAMES
      for (const person in data) {
        let new_name = await get_NickName(person, blockchain);
        if (new_name) {
          data[new_name] = data[person];
          delete data[person];
        }
      }


      let chartDataWallet = [];
      for (const name in data) {
        let dataset = []
        for (const d in data[name].dailyWallet) {
          dataset.push({ x: d, y: data[name].dailyWallet[d] })
        }
        chartDataWallet.push({
          name: name,
          data: dataset
        })
      }

      let chartDataPie = [];
      for (const name in data) {
        chartDataPie.push({
          value: data[name].totalAmount,
          name: name
        })
      }
      let ServerUsersBalance = 0;
      Object.keys(chartDataPie).forEach(key => {
        const value = chartDataPie[key];
        ServerUsersBalance += value.value
      });
      GenPieGraph(chartDataPie)
      GenGraph(chartDataWallet)
      //* RECENT BLOCKS
      let recent_blocks = blockchain.chain.slice(-5).reverse();
      for (const block in recent_blocks) {
        let mes, badge;
        if (recent_blocks[block].transactions.amount) {
          mes = `</br>Amount: <strong>${recent_blocks[block].transactions.amount}€</strong>`
          badge = "text-success"
          if (recent_blocks[block].message.includes("Tax")) {
            badge = "text-danger"
          }
          if (recent_blocks[block].message.includes("Daily Reward")) {
            badge = "text-warning"
          }

        } else {
          mes = `</br>Item: <strong>${recent_blocks[block].transactions.item}</strong>`
          badge = "text-info"
        }
        let nameFrom, nameTo;
        nameFrom = get_NickName(recent_blocks[block].transactions.fromAddress, blockchain);
        if (!nameFrom) { nameFrom = "" } else { nameFrom = `<strong>(${nameFrom})</strong>` }
        nameTo = get_NickName(recent_blocks[block].transactions.toAddress, blockchain);
        if (!nameTo) { nameTo = "" } else { nameTo = `<strong>(${nameTo})</strong>` }

        $(".recent-blocks").append(`<div class="activity-item d-flex">
                  <div class="activite-label">#${recent_blocks[block].height}<br>${timeAgo(recent_blocks[block].timestamp)}</div>
                  <i class='bi bi-circle-fill activity-badge ${badge} align-self-start'></i>
                  <div class="activity-content">
                    <strong>${recent_blocks[block].message.substring(0, 45)}${(recent_blocks[block].message.length > 45 ? "..." : "")}</strong>
                      </br>From: ${recent_blocks[block].transactions.fromAddress} ${nameFrom}
                    </br>To: ${recent_blocks[block].transactions.toAddress} ${nameTo}
                      ${mes}
                  </div>
                </div>`)
      }




      //PRINT TOP SELLING
      let nameOwner, nameLastOwner;
      for (const a in listOfItems) {
        let ogg = listOfItems[a];
        nameOwner = get_NickName(ogg.owner, blockchain);
        if (!nameOwner) { nameOwner = "" } else { nameOwner = `<strong>(${nameOwner})</strong>` }
        nameLastOwner = get_NickName(ogg.last_owner, blockchain);
        if (!nameLastOwner) { nameLastOwner = "" } else { nameLastOwner = `<strong>(${nameLastOwner})</strong>` }
        let immagine_pokemon;
        await $.get('https://pokeapi.co/api/v2/pokemon/' + a.split("_")[0], function (response) {
          immagine_pokemon = response.sprites.other["official-artwork"].front_default;
        }).fail(function () {
          console.log("Error retrieving data from API");
        });

        let b = `<tr>
                        <th scope="row"><a href="#"><img src="${immagine_pokemon}" alt=""></a></th>
                        <td><a href="#" class="text-primary fw-bold">${a}</a></td>
                        <td>${ogg.value}</td>
                        <td>${ogg.owner} ${nameOwner}</td>
                        <td>${ogg.last_owner} ${nameLastOwner}</td>
                        <td>${ogg.MaxPrice}€</td>
                      </tr>`
        $(".Top-selling-p").append(b);
      }
      const formatter = new Intl.NumberFormat('it-IT', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 0
      });
      $(".max-money").text(formatter.format(blockchainInfo.totalAmount))
      $(".max-blocks").text(blockchainInfo.numBlocks)
      $(".max-users").text(Object.keys(blockchainInfo.addresses).length)
      $(".bilancio-server").text(formatter.format(ServerUsersBalance))

    })
    //.catch(error => console.error(error));
    $(document).ready(function () {
      // Triggered when the form is submitted
      $(".search-form").submit(function (event) {
        event.preventDefault(); // prevent default form submission
        const inputValue = $("input[name='query']").val();
        const url = "./users-profile.html?address=" + inputValue;
        window.location.href = url;
      });
    });
  </script>
  <!-- Vendor JS Files -->
  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/chart.js/chart.umd.js"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/vendor/quill/quill.min.js"></script>
  <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
  <script src="assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>


  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>



</body>

</html>
